# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Development Firebase Hosting on merge
"on":
    push:
        branches:
            - dev

env:
    API_KEY: ${{ secrets.DEV_API_KEY }}
    AUTH_DOMAIN: ${{ secrets.DEV_AUTH_DOMAIN }}
    DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
    PROJECT_ID: ${{ secrets.DEV_PROJECT_ID}}
    STORAGE_BUCKET: ${{ secrets.DEV_STORAGE_BUCKET }}
    MESSAGING_SENDER_ID: ${{ secrets.DEV_MESSAGING_SENDER_ID }}
    APP_ID: ${{ secrets.DEV_APP_ID }}
    # MEASUREMENT_ID: ${{ secrets.DEV_MEASUREMENT_ID }}
    SENTRY_ENVIRONMENT: "dev"

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - run: npm install
            - run: npm run build
            - uses: FirebaseExtended/action-hosting-deploy@v0
              with:
                repoToken: '${{ secrets.GITHUB_TOKEN }}'
                firebaseServiceAccount: '${{ secrets.DEV_FIREBASE_SERVICE_ACCOUNT }}'
                channelId: live
                projectId: '${{ secrets.DEV_PROJECT_ID }}'
            - name: Install npm packages for cloud functions
              run: |
                cd functions
                npm install
            - name: Set the Firebase Config
              uses: w9jds/firebase-action@master
              with:
                  args: functions:config:set app.id="dapp_34d0a87e7e5f4b1b9e8457b0c6a56ce0" app.secret="964c07b86149d539118df2dab6576ed7183c9c03c0b5d903f1c9fe0fcf803af6" app.url="https://dev.sable.letsdive.io"
              env:
                  GCP_SA_KEY: ${{ secrets.DEV_GCP_SA_KEY }}
                  TARGET: dev
            - name: Deploy to Firebase Cloud functions
              uses: w9jds/firebase-action@master
              with:
                args: deploy --only functions
              env:
                GCP_SA_KEY: ${{ secrets.DEV_GCP_SA_KEY }}
                TARGET: dev
