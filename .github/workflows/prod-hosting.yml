# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Production Firebase Hosting on merge
"on":
    push:
        branches:
            - prod

env:
    API_KEY: ${{ secrets.API_KEY }}
    AUTH_DOMAIN: ${{ secrets.AUTH_DOMAIN }}
    DATABASE_URL: ${{ secrets.DATABASE_URL }}
    PROJECT_ID: ${{ secrets.PROJECT_ID}}
    STORAGE_BUCKET: ${{ secrets.STORAGE_BUCKET }}
    MESSAGING_SENDER_ID: ${{ secrets.MESSAGING_SENDER_ID }}
    APP_ID: ${{ secrets.APP_ID }}
    MEASUREMENT_ID: ${{ secrets.MEASUREMENT_ID }}
    SENTRY_ENVIRONMENT: "prod"

jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - run: npm install
            - run: npm run build
            - uses: FirebaseExtended/action-hosting-deploy@v0
              with:
                  repoToken: '${{ secrets.GITHUB_TOKEN }}'
                  firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
                  channelId: live
                  projectId: '${{ secrets.PROJECT_ID }}'
            - name: Install npm packages for cloud functions
              run: |
                  cd functions
                  npm install
            - name: Set the Firebase Config
              uses: w9jds/firebase-action@master
              with:
                  args: functions:config:set app.id=${{secrets.DAPP_ID}} app.secret=${{secrets.DAPP_SECRET}} app.url=${{secrets.DAPP_URL}}
              env:
                  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
                  TARGET: dev
            - name: Deploy to Firebase Cloud functions
              uses: w9jds/firebase-action@master
              with:
                  args: deploy --only functions
              env:
                  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
                  TARGET: prod
